name: iOS starter workflow

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    name: Build iOS app
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set Default Scheme
        run: |
          # Obtener lista en json y tomar el primer scheme disponible
          scheme_list=$(xcodebuild -list -json | tr -d "\n")
          default_scheme=$(echo "$scheme_list" | ruby -e "require 'json'; j=JSON.parse(STDIN.read); puts (j['project']['schemes'] || j['workspace']['schemes'] || []).first")
          
          if [ -z "$default_scheme" ] || [ "$default_scheme" == "null" ]; then
            echo "ERROR: No se encontró scheme automáticamente."
            exit 1
          fi
          echo "$default_scheme" > default
          echo "Using default scheme: $default_scheme"

      - name: Build
        env:
          platform: "iOS Simulator"
        run: |
          # Leer scheme guardado
          scheme=$(cat default)
          
          # Detectar workspace o project
          workspace=$(ls -1 *.xcworkspace 2>/dev/null | head -n 1 || true)
          project=$(ls -1 *.xcodeproj 2>/dev/null | head -n 1 || true)

          if [ -n "$workspace" ]; then
            file_flag="-workspace"
            file_to_build="$workspace"
          elif [ -n "$project" ]; then
            file_flag="-project"
            file_to_build="$project"
          else
            echo "ERROR: No se encontró .xcworkspace ni .xcodeproj"
            exit 1
          fi

          # Detección de dispositivo (iPhone 16 para asegurar compatibilidad con Xcode 16)
          device="iPhone 16"
          
          echo "Building Scheme: $scheme"
          echo "Using $file_flag: $file_to_build"
          echo "Destination: $device"

          # Ejecutar build
          # Nota: Se corrigió la sintaxis de -$filetype_parameter a $file_flag
          xcodebuild build-for-testing \
            $file_flag "$file_to_build" \
            -scheme "$scheme" \
            -destination "platform=$platform,name=$device" \
            ONLY_ACTIVE_ARCH=NO
