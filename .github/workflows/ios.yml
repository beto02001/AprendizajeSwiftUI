name: iOS starter workflow

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    name: Build iOS app
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set Default Scheme
        run: |
          # Obtener lista en json y tomar el primer scheme disponible (más fiable que targets)
          scheme_list=$(xcodebuild -list -json | tr -d "\n")
          default_scheme=$(echo "$scheme_list" | ruby -e "require 'json'; j=JSON.parse(STDIN.read); puts (j['project']['schemes'] || []).first")
          if [ -z "$default_scheme" ]; then
            echo "ERROR: No se encontró scheme automáticamente. Lista completa:"
            echo "$scheme_list"
            exit 1
          fi
          echo "$default_scheme" > default
          echo "Using default scheme: $default_scheme"

      - name: Build
        env:
          platform: "iOS Simulator"
        run: |
          # leer scheme (o usar default si no se pasó otro)
          scheme=$(cat default)
          echo "scheme: <$scheme>"

          # Detectar primero workspace o project de forma robusta (solo el primer match)
          workspace=$(ls -1 *.xcworkspace 2>/dev/null | head -n 1 || true)
          project=$(ls -1 *.xcodeproj 2>/dev/null | head -n 1 || true)

          if [ -n "$workspace" ]; then
            filetype_parameter="workspace"
            file_to_build="$workspace"
          elif [ -n "$project" ]; then
            filetype_parameter="project"
            file_to_build="$project"
          else
            echo "ERROR: No se encontró .xcworkspace ni .xcodeproj en el repo."
            ls -la
            exit 1
          fi

          echo "Using $filetype_parameter: <$file_to_build>"

          # Device detection robusta (xcrun xctrace envia a stderr, por eso 2>&1)
          device=$(xcrun xctrace list devices 2>&1 | grep -oE 'iPhone.*?[^\(]+' | head -1 | awk '{$1=$1;print}' | sed "s/ Simulator$//")
          if [ -z "$device" ]; then
            echo "ERROR: No se pudo detectar un simulador iPhone disponible."
            xcrun simctl list
            exit 1
          fi
          echo "device: <$device>"

          # Debug: listar directorio antes de invocar xcodebuild
          echo "Contenido del directorio:"
          ls -la

          # Ejecutar build (build-for-testing si luego quieres tests)
          xcodebuild build-for-testing \
            -scheme "$scheme" \
            -"$filetype_parameter" "$file_to_build" \
            -destination "platform=$platform,name=$device" \
            ONLY_ACTIVE_ARCH=NO
